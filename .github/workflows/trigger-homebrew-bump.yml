name: Trigger Homebrew bump

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Override RisingWave version (e.g. 2.5.1). Leave empty to use latest stable release.'
        required: false
        type: string

jobs:
  dispatch-homebrew-bump:
    if: ${{ github.event_name == 'workflow_dispatch' || !github.event.release.prerelease }}
    runs-on: ubuntu-latest
    steps:
      - name: Resolve RisingWave version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger homebrew-risingwave workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_TOKEN }}
          script: |
            const owner = "risingwavelabs";
            const repo = "homebrew-risingwave";
            const targetName = "bump risingwave";
            const rawVersion = "${{ steps.version.outputs.version }}";
            const version = rawVersion ? rawVersion.replace(/^v/, "") : "";

            const workflows = await github.paginate(github.rest.actions.listRepoWorkflows, {
              owner,
              repo,
            });

            const workflow = workflows.find((wf) => wf.name === targetName);
            if (!workflow) {
              core.setFailed(`Workflow "${targetName}" not found in ${owner}/${repo}`);
              return;
            }
            const workflowUrl =
              workflow.html_url ||
              `https://github.com/${owner}/${repo}/actions/workflows/${workflow.path}`;
            core.info(`Workflow URL: ${workflowUrl}`);

            const ref = workflow.default_branch || "main";
            const inputs = version ? { version } : {};
            const dispatchTime = new Date();
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: workflow.id,
              ref,
              inputs,
            });

            const detail = version ? `version ${version}` : "latest stable release (no override)";
            core.info(`Dispatched "${targetName}" with ${detail}`);

            const earliestTime = new Date(dispatchTime.getTime() - 60000);
            const maxAttempts = 6;
            const delayMs = 5000;
            for (let attempt = 1; attempt <= maxAttempts; attempt += 1) {
              await new Promise((resolve) => setTimeout(resolve, delayMs));
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                event: "workflow_dispatch",
                branch: ref,
                per_page: 5,
              });
              const run = runs.data.workflow_runs.find(
                (candidate) => new Date(candidate.created_at) >= earliestTime,
              );
              if (run?.html_url) {
                core.info(`Workflow run URL: ${run.html_url}`);
                break;
              }
              if (attempt === maxAttempts) {
                core.warning("Workflow run not found yet. Check Actions page later.");
              } else {
                core.info(`Waiting for workflow run... (${attempt}/${maxAttempts})`);
              }
            }
