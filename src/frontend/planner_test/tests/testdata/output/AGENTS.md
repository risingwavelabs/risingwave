# AGENTS.md - Planner Test Output Files

## 1. Scope

Policies for `src/frontend/planner_test/tests/testdata/output` - auto-generated golden-file output for RisingWave's planner testing framework.

## 2. Purpose

This directory contains auto-generated `.plan` files that serve as golden references:

- **Golden-file testing**: Expected query plans for regression detection
- **Plan stability**: Ensures query plans remain consistent across code changes
- **Version controlled**: Changes to plans are reviewed through PR diffs
- **CI validation**: Tests fail when actual output differs from expected
- **Documentation**: Human-readable plan outputs document optimizer behavior

Output files are generated automatically; manual edits are overwritten.

## 3. Structure

```
src/frontend/planner_test/tests/testdata/output/
├── agg.plan                  # Aggregation query plans
├── join.plan                 # Join query plans
├── tpch.plan                 # TPC-H benchmark plans
├── nexmark.plan              # Nexmark streaming plans
├── subquery.plan             # Subquery plans
├── *.plan                    # One file per input YAML file
└── (generated files match input/*.yaml)
```

## 4. Key Files

| File | Purpose |
|------|---------|
| `*.plan` | Auto-generated expected plan output (one per input file) |
| Format | Human-readable text format showing logical/batch/stream plans |

## 5. Edit Rules (Must)

- DO NOT EDIT FILES MANUALLY - always use `./risedev do-apply-planner-test`
- Review plan changes carefully in PR diffs
- Understand why plans changed before accepting updates
- Ensure plan changes are intentional and correct
- Run tests locally after updating to verify
- Commit updated plans with the code changes that caused them

## 6. Forbidden Changes (Must Not)

- Never edit `.plan` files manually
- Never commit manually edited plan files
- Never bypass plan validation in CI
- Never ignore unexpected plan changes
- Never delete plan files without removing corresponding input files

## 7. Test Entry

| Test Type | Entry Command |
|-----------|---------------|
| Validate outputs | `./risedev run-planner-test` |
| Update outputs | `./risedev do-apply-planner-test` or `./risedev dapt` |
| Single file update | `./risedev do-apply-planner-test <name>` |

## 8. Dependencies & Contracts

- Generated by: `planner_test_runner.rs` with `UPDATE_EXPECT=1`
- Compared by: `expect-test` crate for string matching
- Format: Human-readable text with indentation
- Correspondence: One `.plan` file per `input/*.yaml` file
- Version control: Must be committed with source changes

## 9. Overrides

None. Inherits all rules from parent `/home/k11/risingwave/src/frontend/planner_test/tests/testdata/AGENTS.md`.

## 10. Update Triggers

Regenerate this file when:
- Output file format changes
- Generation mechanism updated
- Golden-file comparison logic modified

## 11. Metadata

- Created: 2025-02-22
- Version: 1.0
- Parent: /home/k11/risingwave/src/frontend/planner_test/tests/testdata/AGENTS.md
