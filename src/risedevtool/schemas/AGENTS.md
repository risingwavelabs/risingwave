# AGENTS.md - risedevtool JSON Schemas

## 1. Scope

Policies for `src/risedevtool/schemas` - JSON schema definitions for validating RiseDev configuration files.

## 2. Purpose

This directory contains JSON Schema definitions that provide validation and IDE auto-completion for `risedev.yml` configuration files. These schemas ensure configuration correctness before runtime and enable editor support for developers writing RiseDev profiles.

## 3. Structure

```
schemas/
├── risedev.json              # Main schema: validates entire risedev.yml structure
├── profile.json              # Profile schema: referenced by risedev.json for profile definitions
└── risedev-profiles.user.json # User-specific profile overrides (auto-generated)
```

## 4. Key Files

| File | Purpose |
|------|---------|
| `risedev.json` | Root JSON schema defining the RiseDev configuration structure with `profile` and `template` sections |
| `profile.json` | Sub-schema for profile definitions with `steps`, `config-path`, and `env` properties |
| `risedev-profiles.user.json` | User-specific profile customizations, auto-generated by `./risedev configure` |

## 5. Edit Rules (Must)

- Use JSON Schema Draft 07 (`$schema: "http://json-schema.org/draft-07/schema#"`)
- Reference sub-schemas using relative paths (`"$ref": "./profile.json"`)
- Follow camelCase for property names in schema definitions
- Add `description` fields to all properties and patternProperties
- Use `patternProperties` with valid regex for flexible key names (e.g., `^[_a-zA-Z][a-zA-Z0-9_-]*$`)
- Specify `required` arrays explicitly for all object types
- Set `additionalProperties: false` on objects with fixed property sets
- Update both schemas when adding cross-referenced configuration fields
- Test schema changes against existing `risedev.yml` files before committing
- Validate JSON syntax with `python -m json.tool` or equivalent before saving

## 6. Forbidden Changes (Must Not)

- Modify schema structure without updating corresponding `risedev.yml` examples in documentation
- Delete or modify `risedev-profiles.user.json` manually (use `./risedev configure` instead)
- Change `$ref` paths to non-existent schema files
- Remove `required` fields from schemas without backward compatibility review
- Use JSON Schema features beyond Draft 07 (not supported by all validators)
- Break validation for existing valid `risedev.yml` configurations
- Change pattern property regex without updating documentation examples
- Remove `description` fields from existing properties

## 7. Test Entry

| Test Type | Entry Command |
|-----------|---------------|
| Schema syntax | `python -m json.tool schemas/risedev.json` |
| Schema validation | Validate `risedev.yml` against schema in IDE |
| Config test | `./risedev dev <profile>` (tests actual config) |
| Full test | `./risedev c` (includes config validation) |

## 8. Dependencies & Contracts

- JSON Schema Draft 07 compliance required
- `risedev.json` references `profile.json` via relative path (`./profile.json`)
- Schema validation integrated with IDE/editor YAML support
- Pattern property regex must match valid component IDs and profile names
- Schema changes must be synchronized with `src/service_config.rs` struct definitions

## 9. Overrides

None. Follows parent `src/risedevtool/AGENTS.md` rules for config expansion patterns.

## 10. Update Triggers

Regenerate this file when:
- New configuration field added to service definitions
- New profile property introduced (steps, config-path, env)
- Schema Draft version changes
- New schema file added to directory
- Pattern property regex patterns modified

## 11. Metadata

- Created: 2025-02-22
- Version: 1.0
- Parent: `/home/k11/risingwave/src/risedevtool/AGENTS.md`
