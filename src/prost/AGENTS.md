# AGENTS.md - src/prost

## 1. Scope

Policies for the `risingwave_pb` crate containing auto-generated Rust code from Protocol Buffer definitions. This directory produces the `risingwave_pb` crate.

## 2. Purpose

This crate contains:
- Auto-generated Rust structs and gRPC service definitions from `.proto` files
- Typed ID wrappers for type-safe entity identifiers (TableId, WorkerId, etc.)
- Hand-written trait implementations extending generated types
- Proc-macro helpers for protobuf code generation

The generated code defines the wire protocol for all inter-service communication in RisingWave.

## 3. Structure

```
src/prost/
├── Cargo.toml           # Crate manifest, package name: risingwave_pb
├── build.rs             # Build script - generates code from proto files
├── helpers/             # Proc-macro helper crate (prost-helpers)
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs       # AnyPB and Version derive macros
│       └── generate.rs  # Code generation for field getters
└── src/
    ├── lib.rs           # Hand-written extensions to generated types
    ├── id.rs            # TypedId wrappers for type-safe IDs
    ├── *.rs             # Auto-generated protobuf Rust code (28 modules)
    ├── *.serde.rs       # Auto-generated JSON serialization impls
    └── sim/             # Simulation test variants of generated code
```

## 4. Key Files

| File | Purpose |
|------|---------|
| `build.rs` | Build script that invokes prost/tonic to generate Rust from `../../proto/*.proto` |
| `src/lib.rs` | Hand-written impl blocks extending generated protobuf types |
| `src/id.rs` | TypedId struct and type aliases (TableId, WorkerId, FragmentId, etc.) |
| `src/sim/*.rs` | Simulation test versions of generated code (used with `madsim` cfg) |
| `helpers/src/lib.rs` | Proc-macros: `AnyPB` (adds getters, Pb- aliases) and `Version` (adds LATEST const) |

## 5. Edit Rules (Must)

- Edit ONLY `build.rs`, `src/lib.rs`, `src/id.rs`, and `helpers/` - these are hand-written
- To change protocol definitions, modify files in `../../proto/` and rebuild
- When modifying `build.rs`, verify generation with `cargo build -p risingwave_pb`
- Add new typed ID types in `src/id.rs` following existing patterns
- Add new getter methods in `src/lib.rs` using `impl` blocks on generated types
- Ensure `check_declared_wrapped_fields_sorted()` passes after adding wrapped ID fields
- Comment any workarounds for prost/tonic limitations with issue links

## 6. Forbidden Changes (Must Not)

- Manually edit any `src/*.rs` files that are auto-generated (all except lib.rs, id.rs)
- Edit any `*.serde.rs` files - these are auto-generated by pbjson-build
- Edit files in `src/sim/` directly - these are generated copies
- Remove or modify the `#[rustfmt::skip]` attributes on module declarations
- Delete the `file_descriptor_set.bin` binary file
- Add manual `unsafe` implementations without justification
- Commit changes that break the deterministic generation check

## 7. Test Entry

| Test Type | Entry Command |
|-----------|---------------|
| Unit tests | `cargo test -p risingwave_pb` |
| Build check | `cargo build -p risingwave_pb` |
| Check generation | `cargo build -p risingwave_pb --features check` (if available) |

Note: Most testing is via integration tests in dependent crates. Generated code is exercised through `meta`, `frontend`, `compute`, etc.

## 8. Dependencies & Contracts

- **prost**: Core protobuf code generation (workspace dependency)
- **tonic**: gRPC service generation (workspace dependency)
- **tonic-build**: Build-time gRPC generation
- **pbjson-build**: JSON serialization support
- **prost-helpers**: Local proc-macro crate for custom derives
- **enum-as-inner, strum**: Enum utility derives applied to generated types
- **sea-orm**: Database ORM integration for TypedId

Contracts:
- Generated types derive: `Message`, `AnyPB`, and serde traits where applicable
- All ID fields use typed wrappers (e.g., `TableId` instead of `u32`)
- gRPC services use `tonic` with `compile_well_known_types(true)`
- Simulation builds use `#[cfg_attr(madsim, path = "sim/...")]` redirection

## 9. Overrides

Overrides parent AGENTS.md rules:

| Parent Rule | Override |
|-------------|----------|
| "Run cargo fmt before committing" | Generated code is formatted by prost; `#[rustfmt::skip]` used on modules |
| "Add unit tests for new public functions" | N/A for generated code; tests go in `lib.rs` or dependent crates |
| "Follow existing code patterns" | Generated code follows prost output patterns; hand-written code follows crate conventions |

## 10. Update Triggers

Regenerate this file when:
- New proto modules are added to `build.rs` proto_files list
- Build dependencies (prost, tonic) are upgraded
- New typed ID categories are added to `id.rs`
- The `helpers/` proc-macro API changes
- Simulation test infrastructure changes

## 11. Metadata

- Created: 2025-02-22
- Version: 1.0
- Parent: /home/k11/risingwave/AGENTS.md
