# Benchmark configuration
benchmark_name: unaligned_join_backpressure_slow_finish

setup_sql: |
  set streaming_enable_unaligned_join = true;

  create table dim(v1 int);
  create table fact(v0 int primary key, v1 int, v2 varchar, v3 varchar);
  create table t(v0 int primary key, v1 int, v2 varchar, v3 varchar);

  insert into dim values (1), (2);

  insert into fact
    select x as v0, 1 as v1, 'abcdefgakjandjkw' as v2, 'jkb1ku1bu' as v3
    from generate_series(1, 200) t(x);
  insert into fact
    select x as v0, 2 as v1, 'abcdefgakjandjkw' as v2, 'jkb1ku1bu' as v3
    from generate_series(201, 400) t(x);
  
  create sink s_join into t as
    select fact.v0, fact.v1, fact.v2, fact.v3
    from fact join dim on fact.v1 = dim.v1;
  
  create table t2(v0 int primary key, v1 int, v2 varchar, v3 varchar);

  create sink s2 into t from t2;

  create materialized view mv_t_agg as
  select v0, count(*) as cnt, sum(v0), string_agg(v2, ',')
  from t
  group by v0;

  insert into t2
  select x as v0, 3 as v1, 't2data' as v2, 'shhsfdffk' as v3
  from generate_series(401, 600) t(x);
  flush;
prepare_sql: |

benchmark_sql: |
  delete from dim;
  delete from t2;
  flush;


conclude_sql: |
  insert into dim values (1), (2);
  flush;

cleanup_sql: |
  drop sink if exists s2;
  drop sink if exists s_join;
  drop materialized view if exists mv_t_agg;
  drop table if exists t2;
  drop table if exists t;
  drop table if exists dim;
  drop table if exists fact;

runs: 3