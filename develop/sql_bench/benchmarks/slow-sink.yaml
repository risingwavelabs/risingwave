# Benchmark configuration
benchmark_name: unaligned_join_backpressure_slow_finish

setup_sql: |
  set streaming_enable_unaligned_join = true;
  create table dim(v1 int);
  create table fact(v0 int primary key, v1 int, v2 varchar, v3 varchar);

  create table t(v0 int primary key, v1 int, v2 varchar, v3 varchar);

  insert into dim values (1), (2);

  insert into fact
    select x as v0, 1 as v1, 'abcdefgakjandjkw' as v2, 'jkb1ku1bu' as v3
    from generate_series(1, 2000000) t(x);
  insert into fact
    select x as v0, 2 as v1, 'abcdefgakjandjkw' as v2, 'jkb1ku1bu' as v3
    from generate_series(2000001, 4000000) t(x);

  create sink s_join into t as
    select fact.v0, fact.v1, fact.v2, fact.v3
    from fact join dim on fact.v1 = dim.v1;


  create materialized view mv_t_agg as
  select v0, count(*) as cnt, sum(v0), string_agg(v2, ',')
  from t join dim on t.v1 = dim.v1
  group by v0;
  flush;
prepare_sql: |

benchmark_sql: |
  delete from dim;
  flush;


conclude_sql: |
  insert into dim values (1), (2);
  flush;

cleanup_sql: |
  drop sink if exists s_join;
  drop materialized view if exists mv_t_agg;
  drop table if exists t;
  drop table if exists dim;
  drop table if exists fact;

runs: 3
