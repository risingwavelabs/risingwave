syntax = "proto3";

package iceberg_compaction;

option optimize_for = SPEED;

message SubscribeIcebergCompactionEventRequest {
  // Register provides the context_id of the corresponding Compactor.
  message Register {
    uint32 context_id = 1;
  }

  // PullTask provides the number of tasks needed for the Compactor.
  message PullTask {
    uint32 pull_task_count = 1;
  }

  // ReportPlan reports plan execution result to meta.
  message ReportPlan {
    PlanKey key = 1;

    enum Status {
      STATUS_UNSPECIFIED = 0;
      SUCCESS = 1;
      FAILED = 2;
      CANCELED = 3;
    }
    Status status = 2;

    string error_message = 3;

    PlanResult result = 4;

    // Attempt number for deduplication on meta.
    uint32 attempt = 5;
  }

  oneof event {
    // Compactor will register its own context_id with Meta via Register and establish a bi-directional streaming rpc.
    Register register = 1;

    // Compactor will recalculate the number of tasks needed locally after receiving the PullTaskAck and get the next batch of tasks from Meta via PullTask.
    PullTask pull_task = 2;

    // Compactor will report plan completion to meta.
    ReportPlan report_plan = 4;
  }

  uint64 create_at = 3;
}

message PlanKey {
  uint64 task_id = 1;
  uint32 plan_index = 2;
}

message IcebergCompactionTask {
  uint64 task_id = 1;
  // Now we only support iceberg table full compaction.
  // compactor will get the information of the iceberg table from the properties
  map<string, string> props = 2;

  enum TaskType {
    UNSPECIFIED = 0;
    // Full compaction task.
    FULL = 1;

    // Small data file compaction task.
    SMALL_FILES = 2;

    FILES_WITH_DELETE = 3;
  }

  TaskType task_type = 3;
}

message SerializedDataFile {
  // JSON serialized iceberg::spec::manifest::SerializedDataFile.
  bytes json = 1;
  // Partition spec id for decoding.
  int32 partition_spec_id = 2;
}

message PlanResult {
  repeated SerializedDataFile added_data_files = 1;
  repeated SerializedDataFile added_position_delete_files = 2;
  repeated SerializedDataFile added_equality_delete_files = 3;

  message RewriteStats {
    int64 input_data_files = 1;
    int64 input_delete_files = 2;
    int64 output_files = 3;
    int64 output_bytes = 4;
  }
  RewriteStats stats = 4;
}

message SubscribeIcebergCompactionEventResponse {
  // PullTaskAck is a response, the meta will return a PullTaskAck after distributing the task requested by the PullTask.
  // The Compactor receives the PullTaskAck and remakes its state and tries to initiate the next PullTask.
  message PullTaskAck {}

  oneof event {
    IcebergCompactionTask compact_task = 1;
    PullTaskAck pull_task_ack = 2;
  }

  uint64 create_at = 7;
}
