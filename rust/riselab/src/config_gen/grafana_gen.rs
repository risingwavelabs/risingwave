use std::path::Path;
use std::{env, fs};

use anyhow::{anyhow, Result};

use crate::GrafanaConfig;
pub struct GrafanaGen;

impl GrafanaGen {
    pub fn gen_custom_ini(&self, config: &GrafanaConfig) -> String {
        format!(
            r#"# --- THIS FILE IS AUTO GENERATED BY RISELAB ---
[server]
http_addr = {grafana_host}
http_port = {grafana_port}

[users]
default_theme = light

[auth.anonymous]
enabled = true
org_role = Admin
    "#,
            grafana_host = config.address,
            grafana_port = config.port
        )
    }

    pub fn gen_datasource_yml(&self, config: &GrafanaConfig) -> Result<String> {
        let provide_prometheus = config.provide_prometheus.as_ref().unwrap();
        if provide_prometheus.len() != 1 {
            return Err(anyhow!(
                "expect 1 prometheus nodes, found {}",
                provide_prometheus.len()
            ));
        }
        let prometheus = &provide_prometheus[0];
        let yml = format!(
            r#"# --- THIS FILE IS AUTO GENERATED BY RISELAB ---
apiVersion: 1
deleteDatasources:
  - name: riselab-prometheus
datasources:
  - name: riselab-prometheus
    type: prometheus
    access: proxy
    url: http://{prometheus_host}:{prometheus_port}
    withCredentials: false
    isDefault: false
    tlsAuth: false
    tlsAuthWithCACert: false
    version: 1
    editable: true
    isDefault: true
    "#,
            prometheus_host = prometheus.address,
            prometheus_port = prometheus.port
        );
        Ok(yml)
    }

    pub fn gen_dashboard_yml(&self, config: &GrafanaConfig) -> Result<String> {
        let provide_prometheus = config.provide_prometheus.as_ref().unwrap();
        if provide_prometheus.len() != 1 {
            return Err(anyhow!(
                "expect 1 prometheus nodes, found {}",
                provide_prometheus.len()
            ));
        };

        let prefix_bin = env::var("PREFIX_CONFIG")?;
        let dashboard_path = Path::new(&prefix_bin)
            .join("grafana_dashboard.json")
            .to_string_lossy()
            .to_string();

        let json_context = fs::read_to_string(&dashboard_path)?;
        let json_context = json_context.replace("${DS_RISELAB-PROMETHEUS}", "riselab-prometheus");
        fs::write(&dashboard_path, json_context)?;
        let yml = format!(
            r#"# --- THIS FILE IS AUTO GENERATED BY RISELAB ---
apiVersion: 1

providers:
  - name: 'risingwave-grafana'
    orgId: 1
    folder: ''
    folderUid: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 1
    allowUiUpdates: true
    options:
      path: {path}
      foldersFromFilesStructure: false
    "#,
            path = dashboard_path
        );
        Ok(yml)
    }
}
