statement ok
create table items (id int primary key, extra string, text string, embedding vector(3)) append only;

statement ok
insert into items values (1, 'extra1', 'first', get_embedding('first'));

statement ok
create index i on items using hnsw (embedding) include(text) with (distance_type = 'l2');

statement ok
insert into items values (2, 'extra2', 'second', get_embedding('second')), (3, 'extra3', 'third', '[7, 8, 9]'::vector(3));

statement ok
flush;

query T
select * from items order by id;
----
1 extra1 first [1,2,3]
2 extra2 second [4,5,6]
3 extra3 third [7,8,9]

statement ok
create view query_view as select id, text, power(distance, 2)::int as distance from (select id, text, '[3,2,1]'::vector(3) <-> embedding as distance from items order by distance limit 2);

statement ok
set batch_hnsw_ef_search = default;

# ensure that vector index is used
query T
explain(verbose) select * from query_view;
----
<slt:ignore>BatchProject { exprs: [Field(Unnest($1), 1:Int32) as $expr1, Field(Unnest($1), 0:Int32) as $expr2, Pow(Field(Unnest($1), 2:Int32), 2:Float64)::Int32 as $expr3] }
<slt:ignore>└─BatchProjectSet { select_list: [Unnest($1)] }
<slt:ignore>  └─BatchVectorSearch { top_n: 2, distance_type: L2Sqr, index_name: "i", vector: query_vector, lookup_output: [("text", Varchar), ("items.id", Int32)], include_distance: true, hnsw_ef_search: 40 }
<slt:ignore>    └─BatchValues { rows: [['[3,2,1]':Vector(3)]] }<slt:ignore>

statement ok
set batch_hnsw_ef_search = 20;

# ensure that vector index is used
query T
explain(verbose) select * from query_view;
----
<slt:ignore>BatchProject { exprs: [Field(Unnest($1), 1:Int32) as $expr1, Field(Unnest($1), 0:Int32) as $expr2, Pow(Field(Unnest($1), 2:Int32), 2:Float64)::Int32 as $expr3] }
<slt:ignore>└─BatchProjectSet { select_list: [Unnest($1)] }
<slt:ignore>  └─BatchVectorSearch { top_n: 2, distance_type: L2Sqr, index_name: "i", vector: query_vector, lookup_output: [("text", Varchar), ("items.id", Int32)], include_distance: true, hnsw_ef_search: 20 }
<slt:ignore>    └─BatchValues { rows: [['[3,2,1]':Vector(3)]] }

query T
select * from query_view order by distance;
----
1 first 8
2 second 35

statement ok
drop view query_view;

statement ok
drop index i;

statement ok
drop table items;