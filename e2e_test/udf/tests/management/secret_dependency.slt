statement ok
CREATE SCHEMA udf_secret_dep;

statement ok
CREATE SECRET udf_secret_dep.sec_a WITH (backend = 'meta') AS 'token_a';

statement ok
CREATE SECRET udf_secret_dep.sec_b WITH (backend = 'meta') AS 'token_b';

statement ok
CREATE FUNCTION udf_secret_dep.echo_with_secret(i INT) RETURNS INT LANGUAGE python AS $$
def echo_with_secret(i):
    return i
$$ WITH (
    api_token = SECRET udf_secret_dep.sec_a,
    auth_token = SECRET udf_secret_dep.sec_b
);

query T
SELECT udf_secret_dep.echo_with_secret(1);
----
1

statement ok
CREATE FUNCTION udf_secret_dep.read_secret_py() RETURNS VARCHAR LANGUAGE python AS $$
def read_secret_py():
    return RW_UDF_OPTIONS["api_token"]
$$ WITH (api_token = SECRET udf_secret_dep.sec_a);

query T
SELECT udf_secret_dep.read_secret_py();
----
token_a

statement ok
CREATE FUNCTION udf_secret_dep.read_secret_js() RETURNS VARCHAR LANGUAGE javascript AS $$
export function read_secret_js() {
    return RW_UDF_OPTIONS.api_token;
}
$$ WITH (api_token = SECRET udf_secret_dep.sec_b);

query T
SELECT udf_secret_dep.read_secret_js();
----
token_b

statement error
DROP SECRET udf_secret_dep.sec_a;

statement error
DROP SECRET udf_secret_dep.sec_b;

statement ok
CREATE FUNCTION udf_secret_dep.range_with_secret(n INT) RETURNS TABLE (v INT) LANGUAGE python AS $$
def range_with_secret(n):
    for i in range(n):
        yield i
$$ WITH (api_token = SECRET udf_secret_dep.sec_a);

query I
SELECT * FROM udf_secret_dep.range_with_secret(3);
----
0
1
2

statement error
DROP SECRET udf_secret_dep.sec_a;

statement error
CREATE FUNCTION udf_secret_dep.echo_with_plaintext(i INT) RETURNS INT LANGUAGE python AS $$
def echo_with_plaintext(i):
    return i
$$ WITH (api_token = 'plain_token');

statement ok
CREATE USER udf_secret_user;

statement ok
GRANT USAGE, CREATE ON SCHEMA udf_secret_dep TO udf_secret_user;

statement ok
SET ROLE udf_secret_user;

statement error
CREATE FUNCTION udf_secret_dep.echo_with_unauthorized_secret(i INT) RETURNS INT LANGUAGE python AS $$
def echo_with_unauthorized_secret(i):
    return i
$$ WITH (api_token = SECRET udf_secret_dep.sec_a);

statement ok
RESET ROLE;

statement ok
DROP USER udf_secret_user;

statement ok
DROP FUNCTION udf_secret_dep.echo_with_secret(INT);

statement ok
DROP FUNCTION udf_secret_dep.read_secret_py();

statement ok
DROP FUNCTION udf_secret_dep.read_secret_js();

statement ok
DROP FUNCTION udf_secret_dep.range_with_secret(INT);

statement error
CREATE FUNCTION udf_secret_dep.echo_with_missing_secret(i INT) RETURNS INT LANGUAGE python AS $$
def echo_with_missing_secret(i):
    return i
$$ WITH (api_token = SECRET udf_secret_dep.missing_sec);

statement ok
DROP SECRET udf_secret_dep.sec_a;

statement ok
DROP SECRET udf_secret_dep.sec_b;

statement ok
DROP SCHEMA udf_secret_dep CASCADE;
