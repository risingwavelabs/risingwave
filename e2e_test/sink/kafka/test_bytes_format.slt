statement ok
set rw_implicit_flush=true;

statement ok
set sink_decouple = false;

# Test bytes format - single column bytea requirement
statement ok
create table t_single_bytea (
    data bytea
);

# Test that bytes format works with single bytea column
statement ok
create sink sink_bytes_format from t_single_bytea with (
    connector = 'kafka',
    properties.bootstrap.server = 'message_queue:29092',
    topic = 'test-rw-sink-bytes-format'
) format plain encode bytes ( force_append_only = 'true' );

# Test that bytes format fails with multiple columns
statement ok
create table t_multi_columns (
    id integer,
    data bytea
);

statement error
create sink sink_bytes_format_error from t_multi_columns with (
    connector = 'kafka',
    properties.bootstrap.server = 'message_queue:29092',
    topic = 'test-rw-sink-bytes-format-error',
) format plain encode bytes (force_append_only = 'true');
---
db error: ERROR: Failed to run the query

Caused by these errors (recent errors listed first):
    1: gRPC request to meta service (call `/ddl_service.DdlService/CreateSink`) failed: Internal error
    2: failed to validate sink
    3: config error
    4: ENCODE BYTES requires exactly one column, got 2 columns


# Test that bytes format fails with non-bytea column
statement ok
create table t_non_bytea (
    data varchar
);

statement error BYTES format requires the column to be of type BYTEA, but got type character varying
create sink sink_bytes_format_error2 from t_non_bytea with (
    connector = 'kafka',
    properties.bootstrap.server = 'message_queue:29092',
    topic = 'test-rw-sink-bytes-format-error2'
) format plain encode bytes (force_append_only = 'true');

# Test that upsert format with bytes encoding is not supported
statement error connector kafka does not support format Upsert with encode Bytes
create sink sink_upsert_bytes_error from t_single_bytea with (
    connector = 'kafka',
    properties.bootstrap.server = 'message_queue:29092',
    topic = 'test-rw-sink-upsert-bytes-error'
) format upsert encode bytes;

# Test bytes format with key encoding
statement ok
create table t_bytea_with_key (
    key_data bytea primary key,
    value_data bytea
);

statement error sink format/encode/key_encode unsupported
create sink sink_bytes_with_key_error from t_bytea_with_key with (
    connector = 'kafka',
    properties.bootstrap.server = 'message_queue:29092',
    topic = 'test-rw-sink-bytes-with-key',
    primary_key = 'key_data'
) format plain encode bytes (
    force_append_only='true'
) key encode bytes;

# Insert test data
statement ok
insert into t_single_bytea values ('\xDEADBEEF'), ('\xCAFEBABE'), ('\x00112233');

# Test source reading from bytes format sink
statement ok
create table t_source_bytes (data bytea)
with (
  connector = 'kafka',
  properties.bootstrap.server = 'message_queue:29092',
  topic = 'test-rw-sink-bytes-format',
) format plain encode bytes;

sleep 2s

# Verify data roundtrip
query T retry 3 backoff 1s
select data from t_source_bytes order by data;
----
\x00112233
\xcafebabe
\xdeadbeef


# Clean up
statement ok
drop table t_source_bytes;

statement ok
drop sink sink_bytes_format;

statement ok
drop table t_single_bytea;

statement ok
drop table t_multi_columns;

statement ok
drop table t_non_bytea;

statement ok
drop table t_bytea_with_key;
