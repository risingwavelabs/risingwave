statement ok
SET RW_IMPLICIT_FLUSH TO true;

statement ok
create table t_simple_1 (v1 int);

statement ok
create table m_simple (v1 int primary key);

statement ok
create sink s_simple_1 into m_simple as select v1 from t_simple_1;

statement ok
insert into t_simple_1 values (1), (2), (3);

statement ok
flush;

query I rowsort
select * from m_simple;
----
1
2
3

statement ok
alter table m_simple add column v2 int;

statement ok
insert into t_simple_1 values (4);

statement ok
flush;

query II rowsort
select * from m_simple;
----
1	NULL
2	NULL
3	NULL
4	NULL

statement ok
create table t_simple_2 (v1 int, v2 int);

statement ok
create sink s_simple_2 into m_simple as select v1, v2 from t_simple_2;

statement ok
insert into t_simple_2 values (100, 101), (200, 201), (300, 301);

statement ok
flush;

query II rowsort
select * from m_simple;
----
1	NULL
100	101
2	NULL
200	201
3	NULL
300	301
4	NULL

statement error dropping columns in target table of sinks is not supported
alter table m_simple drop column v2;

statement ok
drop sink s_simple_1;

statement ok
drop sink s_simple_2;

statement ok
drop table t_simple_1;

statement ok
drop table t_simple_2;

statement ok
drop table m_simple;

# target table with row_id as primary key
statement ok
create table t_s1 (v1 int);

statement ok
insert into t_s1 values (1), (2), (3);

statement ok
create table t_row_id_as_primary_key (v1 int, v2 int default 1000);

statement ok
create sink s1 into t_row_id_as_primary_key as select v1 from t_s1 with (type = 'append-only', force_append_only = 'true');

statement ok
flush;

query II rowsort
select * from t_row_id_as_primary_key;
----
1	1000
2	1000
3	1000

statement ok
alter table t_row_id_as_primary_key add column v3 int;

query III rowsort
select * from t_row_id_as_primary_key;
----
1	1000	NULL
2	1000	NULL
3	1000	NULL

statement ok
create sink s11 into t_row_id_as_primary_key as select v1+1000 as v1, v1+2000 as v2, v1+3000 as v3 from t_s1 with (type = 'append-only', force_append_only = 'true');

statement ok
flush;

query III rowsort
select * from t_row_id_as_primary_key;
----
1	1000	NULL
1001	2001	3001
1002	2002	3002
1003	2003	3003
2	1000	NULL
3	1000	NULL

statement ok
drop sink s1;

statement ok
drop sink s11;

statement ok
drop table t_row_id_as_primary_key;

statement ok
drop table t_s1;

# target table with append only
statement ok
create table t_s2 (v1 int);

statement ok
insert into t_s2 values (1), (2), (3);

statement ok
create table t_append_only (v1 int, v2 int default 1000) append only;

statement ok
create sink s2 into t_append_only as select v1 from t_s2 with (type = 'append-only', force_append_only = 'true');

statement ok
flush;

query II rowsort
select * from t_append_only;
----
1	1000
2	1000
3	1000

statement ok
alter table t_append_only add column v3 int;

query III rowsort
select * from t_append_only;
----
1	1000	NULL
2	1000	NULL
3	1000	NULL

statement ok
create sink s21 into t_append_only as select v1+1000 as v1, v1+2000 as v2, v1+3000 as v3 from t_s2 with (type = 'append-only', force_append_only = 'true');

statement ok
recover;

query III rowsort
select * from t_append_only;
----
1	1000	NULL
1001	2001	3001
1002	2002	3002
1003	2003	3003
2	1000	NULL
3	1000	NULL

statement ok
drop sink s21;

statement ok
drop sink s2;

statement ok
drop table t_append_only;

statement ok
drop table t_s2;

statement ok
create table t_alter_1 (v1 int, v2 varchar);

statement ok
create table m_alter_1 (v2 varchar, v1 int primary key);

statement ok
create sink s_alter_1 into m_alter_1 (v2, v1) as select v2 as w2, v1 + 10 as w1 from t_alter_1;

statement ok
recover;

statement ok
insert into t_alter_1 values (1, 'a'), (2, 'b'), (3, 'c');

query TI rowsort
select * from m_alter_1;
----
a 11
b 12
c 13

statement ok
alter table m_alter_1 add column v3 int default 1000;

query TII rowsort
select * from m_alter_1;
----
a 11 1000
b 12 1000
c 13 1000

statement ok
insert into t_alter_1 values (4, 'd'), (5, 'e');

query TII rowsort
select * from m_alter_1;
----
a 11 1000
b 12 1000
c 13 1000
d 14 1000
e 15 1000

statement error dropping columns in target table of sinks is not supported
alter table m_alter_1 drop column v2;

statement ok
drop sink s_alter_1;

statement ok
drop table m_alter_1;

statement ok
drop table t_alter_1;

statement ok
create table t1 (v1 int, v2 int);

statement ok
create table t2 (v1 int, v2 int);

statement ok
create sink s1 into t2 from t1 with (type = 'append-only', force_append_only = 'true');

statement ok
alter table t2 add column v3 int default 100;

statement ok
insert into t1 values (1, 11), (2, 12);

query I
select count(*) from t1;
----
2

statement ok
drop sink s1;

statement ok
drop table t2;

statement ok
drop table t1;

statement ok
create table t_drop_1 (v1 int, v2 varchar);

statement ok
create table m_drop_1 (v2 varchar, v1 int primary key);

statement ok
create sink s_drop_1 into m_drop_1 (v2, v1) as select v2, v1 from t_drop_1;

statement ok
recover;

statement ok
insert into t_drop_1 values (1, 'a'), (2, 'b'), (3, 'c');

statement error dropping columns in target table of sinks is not supported
alter table m_drop_1 drop column v2;

statement ok
drop sink s_drop_1;

statement ok
alter table m_drop_1 drop column v2;

query I rowsort
select * from m_drop_1;
----
1
2
3

statement ok
alter table m_drop_1 add column v3 int default 1000;

query II rowsort
select * from m_drop_1;
----
1 1000
2 1000
3 1000

statement ok
create sink s_drop_1 into m_drop_1 (v1, v3) as select v1, v1 + 10 from t_drop_1;

statement ok
insert into t_drop_1 values (4, 'd'), (5, 'e');

query II rowsort
select * from m_drop_1;
----
1 11
2 12
3 13
4 14
5 15

statement error dropping columns in target table of sinks is not supported
alter table m_drop_1 drop column v2;

statement ok
drop sink s_drop_1;

statement ok
drop table m_drop_1;

statement ok
drop table t_drop_1;

statement ok
create table t1 (v1 int);

statement ok
create table t2 (v1 int primary key, v2 int as v1 + 10, v3 timestamptz as proctime());

statement ok
create sink s1 into t2 from t1;

statement ok
insert into t1 values (1), (2);

query II rowsort
select v1, v2 from t2;
----
1 11
2 12

statement ok
alter table t2 add column v4 int default 100;

statement ok
insert into t1 values (3);

query III rowsort
select v1, v2, v4 from t2;
----
1 11 100
2 12 100
3 13 100

statement ok
drop sink s1;

statement ok
drop table t1;

statement ok
drop table t2;

statement ok
create table t1 (v1 int primary key);

statement ok
create sink s1 into t1 as select 1;

statement ok
create materialized view mv1 as select * from t1;

statement ok
alter table t1 add column v2 int default 100;

statement ok
drop table t1 cascade;

# multiple sinks exist before alter: no default
statement ok
create table t_multi_a1 (v1 int);

statement ok
create table t_multi_a2 (v1 int);

statement ok
create table m_multi_a (v1 int primary key);

statement ok
create sink s_multi_a1 into m_multi_a as select v1 from t_multi_a1;

statement ok
create sink s_multi_a2 into m_multi_a as select v1 from t_multi_a2;

statement ok
insert into t_multi_a1 values (1), (2);

statement ok
insert into t_multi_a2 values (100), (200);

statement ok
flush;

query I rowsort
select * from m_multi_a;
----
1
100
2
200

statement ok
alter table m_multi_a add column v2 int;

statement ok
insert into t_multi_a1 values (3);

statement ok
insert into t_multi_a2 values (300);

statement ok
flush;

query II rowsort
select * from m_multi_a;
----
1	NULL
100	NULL
2	NULL
200	NULL
3	NULL
300	NULL

statement ok
drop sink s_multi_a1;

statement ok
drop sink s_multi_a2;

statement ok
drop table t_multi_a1;

statement ok
drop table t_multi_a2;

statement ok
drop table m_multi_a;

# multiple sinks exist before alter: with default, then add a new sink using new column, then alter again
statement ok
create table t_multi_b1 (v1 int);

statement ok
create table t_multi_b2 (v1 int);

statement ok
create table m_multi_b (v1 int primary key);

statement ok
create sink s_multi_b1 into m_multi_b as select v1 from t_multi_b1;

statement ok
create sink s_multi_b2 into m_multi_b as select v1 from t_multi_b2;

statement ok
insert into t_multi_b1 values (1), (2);

statement ok
insert into t_multi_b2 values (10), (20);

statement ok
flush;

query I rowsort
select * from m_multi_b;
----
1
10
2
20

statement ok
alter table m_multi_b add column v2 int default 1000;

query II rowsort
select * from m_multi_b;
----
1 1000
10 1000
2 1000
20 1000

# add a new sink that sinks the newly added column as well
statement ok
create table t_multi_b3 (v1 int, v2 int);

statement ok
create sink s_multi_b3 into m_multi_b as select v1, v2 from t_multi_b3;

statement ok
insert into t_multi_b1 values (3);

statement ok
insert into t_multi_b2 values (30);

statement ok
insert into t_multi_b3 values (5, 50), (6, 60);

statement ok
flush;

query II rowsort
select * from m_multi_b;
----
1 1000
10 1000
2 1000
20 1000
3 1000
30 1000
5 50
6 60

statement ok
alter table m_multi_b add column v3 int default 2000;

query III rowsort
select v1, v2, v3 from m_multi_b;
----
1 1000 2000
10 1000 2000
2 1000 2000
20 1000 2000
3 1000 2000
30 1000 2000
5 50 2000
6 60 2000

statement ok
drop sink s_multi_b1;

statement ok
drop sink s_multi_b2;

statement ok
drop sink s_multi_b3;

statement ok
drop table t_multi_b1;

statement ok
drop table t_multi_b2;

statement ok
drop table t_multi_b3;

statement ok
drop table m_multi_b;

# append-only target with two sinks
statement ok
create table t_multi_c1 (v1 int);

statement ok
create table t_multi_c2 (v1 int);

statement ok
create table m_multi_c (v1 int) append only;

statement ok
create sink s_multi_c1 into m_multi_c as select v1 from t_multi_c1 with (type = 'append-only', force_append_only = 'true');

statement ok
create sink s_multi_c2 into m_multi_c as select v1 from t_multi_c2 with (type = 'append-only', force_append_only = 'true');

statement ok
insert into t_multi_c1 values (1), (2);

statement ok
insert into t_multi_c2 values (100), (200);

statement ok
flush;

query I rowsort
select * from m_multi_c;
----
1
100
2
200

statement ok
alter table m_multi_c add column v2 int default 777;

query II rowsort
select * from m_multi_c;
----
1	777
100	777
2	777
200	777

statement ok
insert into t_multi_c1 values (3);

statement ok
insert into t_multi_c2 values (300);

statement ok
flush;

query II rowsort
select * from m_multi_c;
----
1	777
100	777
2	777
200	777
3	777
300	777

statement ok
drop sink s_multi_c1;

statement ok
drop sink s_multi_c2;

statement ok
drop table t_multi_c1;

statement ok
drop table t_multi_c2;

statement ok
drop table m_multi_c;
