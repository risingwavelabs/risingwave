############## Create kafka seed data

statement ok
create table kafka_seed_data (v1 int);

statement ok
insert into kafka_seed_data select * from generate_series(1, 1000);

############## Sink into kafka

statement ok
create sink kafka_sink
from
  kafka_seed_data with (
    properties.bootstrap.server = 'localhost:29092',
    topic = 'kafka_source',
    type = 'append-only',
    force_append_only='true',
    connector = 'kafka'
);

############## Source from kafka (rate_limit = 0)

# Wait for the topic to create
skipif in-memory
sleep 3s

statement ok
create source kafka_source (v1 int) with (
  connector = 'kafka',
  topic = 'kafka_source',
  properties.bootstrap.server = 'localhost:29092',
  scan.startup.mode = 'earliest',
) FORMAT PLAIN ENCODE JSON

statement ok
flush;

############## Check data

skipif in-memory
sleep 3s

############## Create MV on source

statement ok
SET STREAMING_RATE_LIMIT=0;

statement ok
create materialized view mv1 as select count(*) from kafka_source;

statement ok
create materialized view mv2 as select count(*) from kafka_source;

statement ok
create materialized view mv3 as select count(*) from kafka_source;

statement ok
SET STREAMING_RATE_LIMIT=default;

############## MVs should have 0 records, since source has (rate_limit = 0)

statement ok
flush;

query I
select * from mv1;
----
0

query I
select * from mv2;
----
0

query I
select * from mv3;
----
0

############## Alter Source (rate_limit = 0 --> rate_limit = 1000)

skipif in-memory
query I
alter source kafka_source set streaming_rate_limit to 1000;

skipif in-memory
query I
alter source kafka_source set streaming_rate_limit to default;

skipif in-memory
sleep 3s

skipif in-memory
query I
select count(*) > 0 from mv1;
----
t

skipif in-memory
query I
select count(*) > 0 from mv2;
----
t

skipif in-memory
query I
select count(*) > 0 from mv3;
----
t

############## Cleanup

statement ok
drop materialized view mv1;

statement ok
drop materialized view mv2;

statement ok
drop materialized view mv3;

statement ok
drop source kafka_source;

statement ok
drop sink kafka_sink;

statement ok
drop table kafka_seed_data;