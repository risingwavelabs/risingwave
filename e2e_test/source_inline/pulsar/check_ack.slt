control substitution on

system ok
curl "$PULSAR_HTTP_URL/admin/v2/brokers/ready"
----
ok


system ok
python e2e_test/commands/pulsar_util.py create-topic --topic 'persistent://public/default/check_ack' --partitions 2

system ok
python e2e_test/commands/pulsar_util.py produce -t "persistent://public/default/check_ack" <<EOF
{"f1":1,"f2":"foo"}
{"f1":2,"f2":"bar"}
{"f1":3,"f2":"foo"}
{"f1":4,"f2":"bar"}
{"f1":5,"f2":"foo"}
{"f1":6,"f2":"bar"}
EOF

statement ok
create table t_ack (
  f1 int,
  f2 varchar)
with (
  connector = 'pulsar',
  service.url = '${PULSAR_BROKER_URL}',
  topic = 'persistent://public/default/check_ack',
  subscription.unacked.resend.delay = '10s',
) format plain encode json;

query II retry 3 backoff 1s
select count(distinct f1), count(*) from t_ack;
----
6 6


# wait if it expires and resend message
sleep 10s

query II retry 3 backoff 1s
select count(distinct f1), count(*) from t_ack;
----
6 6


# clean up

statement ok
drop table t_ack;

system ok
python3 e2e_test/commands/pulsar_util.py drop-topic -t "persistent://public/default/check_ack" --force
