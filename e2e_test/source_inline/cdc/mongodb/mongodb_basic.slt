# CDC source basic test
control substitution on

system ok
mongosh 'mongodb://mongodb:27017' <<EOF
db.all_types.insertOne({
  _id: ObjectId('6911a33502454e0f774f8803'),
  f01a_double   : Double(2.5),
  // f01b_double   : Double('-Infinity'), // #21414
  f02_string    : 'Rising',
  f03_object    : {foo: true, bar: false},
  f04_array     : ['e0', 'e1'],
  f05a_binData  : Binary.createFromHexString('deadbeef'),
  f05b_binData  : UUID('00112233-4455-6677-8899-aabbccddeeff'),
  f05c_binData  : Binary.fromFloat32Array(new Float32Array([2, 3])),
  // f06_undefined           // deprecated
  // f07_objectId            // see _id
  f08_bool      : false,
  f09a_date     : ISODate(1),
  f09b_date     : ISODate('1965-08-09T02:00:00Z'),
  f10_null      : null,
  f11_regex     : /ab+c/i,
  // f12_dbPointer           // deprecated
  f13_javascript: Code("function() {}"),
  // f14_symbol              // deprecated
  // f15_javascriptWithScope // deprecated
  f16_int       : Int32(42),
  f17_timestamp : Timestamp({'t': 4, 'i': 7}),
  f18_long      : Long('9007199254740993'),
  f19_decimal   : Decimal128('0.12345678901234567'),
});
EOF


statement ok
CREATE TABLE all_types_extjson (_id JSONB PRIMARY KEY, payload JSONB)
INCLUDE TIMESTAMP as commit_ts
INCLUDE DATABASE_NAME as database_name
INCLUDE COLLECTION_NAME as collection_name
WITH (
  connector = 'mongodb-cdc',
  mongodb.url = 'mongodb://mongodb:27017/?replicaSet=rs0',
  collection.name = 'test.all_types'
);

statement ok
CREATE MATERIALIZED VIEW all_types_access AS
SELECT
    (payload -> 'f01_double')::float8 as f01_double,
    payload ->> 'f02_string' as f02_string,
    payload -> 'f09_date' as f09_date
FROM
    all_types_extjson;

sleep 5s

query I
select * from all_types_extjson;
----
123

# historical data
query I
select count(*) from users where commit_ts > '2025-01-01 00:00:00+00:00';
----
55

query TT
select database_name, collection_name FROM users LIMIT 2;
----
random_data users
random_data users


statement ok
DROP TABLE users cascade
