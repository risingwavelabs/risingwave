control substitution on

# Repro for PR #24380:
# - Upstream table contains generated columns
# - Publication exists (left behind / recreated) with column list not including generated columns
# - Recreate source/table should NOT fail publication validation

system ok
psql -v ON_ERROR_STOP=1 -c "
    DROP TABLE IF EXISTS t_gen;
    CREATE TABLE t_gen (
        id serial PRIMARY KEY,
        a int NOT NULL,
        b int GENERATED ALWAYS AS (a + 1) STORED
    );
    INSERT INTO t_gen (a) VALUES (1), (2);
"

query I retry 30 backoff 1s
select 1;
----
1

statement ok
drop source if exists s_gen cascade;

statement ok
drop source if exists s_gen2 cascade;

statement ok
create source s_gen with (
  connector = 'postgres-cdc',
  hostname = '${PGHOST:localhost}',
  port = '${PGPORT:5432}',
  username = '${PGUSER:$USER}',
  password = '${PGPASSWORD:}',
  database.name = '${PGDATABASE:postgres}',
  schema.name = 'public',
  slot.name = 'rw_slot_gen_1',
  publication.name = 'rw_publication_generated_col',
  publication.create.enable = 'true'
);

# Wait for the cluster to finish recovering after startup.
sleep 5s

# First time create should be OK regardless of publication existence.
statement ok
create table t_gen_rw (
  id int primary key,
  a int,
  b int
) from s_gen table 'public.t_gen';

sleep 1s

statement ok
drop source s_gen cascade;

# Ensure publication exists with a column list (PG15+) and excludes generated columns.
# This simulates a leftover publication that triggers validation on recreate.
system ok
psql -v ON_ERROR_STOP=1 -c "
    DROP PUBLICATION IF EXISTS rw_publication_generated_col;
    CREATE PUBLICATION rw_publication_generated_col FOR TABLE public.t_gen (id, a);
"

statement ok
create source s_gen2 with (
  connector = 'postgres-cdc',
  hostname = '${PGHOST:localhost}',
  port = '${PGPORT:5432}',
  username = '${PGUSER:$USER}',
  password = '${PGPASSWORD:}',
  database.name = '${PGDATABASE:postgres}',
  schema.name = 'public',
  slot.name = 'rw_slot_gen_2',
  publication.name = 'rw_publication_generated_col',
  publication.create.enable = 'true'
);

sleep 5s

# The key assertion: without the fix, this used to fail with
# "The publication '...' does not cover all columns of the table ..."
statement ok
create table t_gen_rw2 (
  id int primary key,
  a int,
  b int
) from s_gen2 table 'public.t_gen';

sleep 1s

query I retry 6 backoff 1s
select count(*) from t_gen_rw2;
----
2

# Clean up
statement ok
drop source s_gen2 cascade;

system ok
psql -v ON_ERROR_STOP=1 -c "
    DROP PUBLICATION IF EXISTS rw_publication_generated_col;
    SELECT pg_drop_replication_slot(slot_name)
      FROM pg_replication_slots
     WHERE slot_name IN ('rw_slot_gen_1', 'rw_slot_gen_2');
    DROP TABLE IF EXISTS t_gen;
"

