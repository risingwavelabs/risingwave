control substitution on

system ok
psql -c "
    DROP TABLE IF EXISTS t;
    CREATE TYPE mood_enum AS ENUM ('happy', 'sad', 'angry');
    CREATE TABLE t (
        v1 integer PRIMARY KEY,
        v42 mood_enum,
        v43 smallserial,
        v44 serial,
        v45 bigserial
    );
"

system ok
psql -c "
    INSERT INTO t (v1, v42, v43, v44, v45) VALUES (1, 'happy', 100, 200, 300);
"

statement ok
create source s with (
 connector = 'postgres-cdc',
 hostname = '${PGHOST:localhost}',
 port = '${PGPORT:5432}',
 username = '${PGUSER:$USER}',
 password = '${PGPASSWORD:}',
 database.name = '${PGDATABASE:postgres}',
 schema.name = 'public',
 slot.name = 'rw_slot',
 auto.schema.change = 'true'
);

statement ok
create table t (
  v1 int primary key,
  v42 character varying,
  v43 smallint,
  v44 int,
  v45 bigint
) from s table 'public.t';

system ok
psql -c "
    INSERT INTO t (v1, v42, v43, v44, v45) VALUES (2, 'happy', 100, 200, 300);
"

sleep 3s

# Verify initial data
query I
SELECT count(*) from t;
----
2

# Test schema change by adding a new column
system ok
psql -c "
    alter table t add column v47_new_added mood_enum default 'sad';
    insert into t (v1, v42, v43, v44, v45, v47_new_added) values (3, 'happy', 100, 200, 300, 'happy');
"

sleep 5s

# Verify schema change worked and new column exists
query TTTT
describe t;
----
v1 integer false NULL
v42 character varying false NULL
v43 smallint false NULL
v44 integer false NULL
v45 bigint false NULL
v47_new_added character varying false NULL
_rw_timestamp timestamp with time zone true NULL
primary key v1 NULL NULL
distribution key v1 NULL NULL
table description t NULL NULL

# Verify both rows exist with the new column
query I
SELECT count(*) from t;
----
3

statement ok
drop source s cascade;