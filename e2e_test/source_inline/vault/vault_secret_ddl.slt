control substitution on

# Test for HashiCorp Vault secret backend

# Test with token auth - using real vault server from docker-compose
statement ok
CREATE SECRET vault_token_secret
WITH (
  backend = 'hashicorp_vault',
  addr = 'http://vault-server:8200',
  path = 'secret/data/myapp/db',
  field = 'password',
  auth_method = 'token',
  auth_token = 'root-token',
  tls_skip_verify = 'true'
) AS NULL;

query T
SHOW SECRETS;
----
public.vault_token_secret


# Test error case - invalid field
statement error
CREATE SECRET vault_invalid_field
WITH (
  backend = 'hashicorp_vault',
  addr = 'http://vault-server:8200',
  path = 'secret/data/myapp/db',
  field = 'nonexistent_field',
  auth_method = 'token',
  auth_token = 'root-token'
) AS NULL;
----
db error: ERROR: Failed to run the query

Caused by:
  Field 'nonexistent_field' not found in secret


# Test error case - missing required parameter
statement error
CREATE SECRET vault_missing_addr
WITH (
  backend = 'hashicorp_vault',
  path = 'secret/data/myapp/db',
  auth_method = 'token',
  auth_token = 'root-token'
) AS NULL;
----
db error: ERROR: Failed to run the query

Caused by:
  Invalid Parameter Value: Invalid HashiCorp Vault configuration: missing field `addr`


# Drop secrets
statement ok
DROP SECRET vault_token_secret;
