control substitution on

# Test for HashiCorp Vault secret backend integration with sources
# hashicorp vault set by `ci/scripts/setup-vault.sh`

# Create a Vault secret for database password
statement ok
CREATE SECRET vault_kafka_password
WITH (
  backend = 'hashicorp_vault',
  addr = '${VAULT_ADDR}',
  path = 'secret/data/myapp/kafka',
  field = 'password',
  auth_method = 'token',
  auth_token = 'root-token'
) AS NULL;

system ok
python3 e2e_test/source_inline/vault/vault_approle_setup.py --db-name $__DATABASE__ --vault-addr ${VAULT_ADDR} --vault-token ${VAULT_TOKEN} --role-name test-role

# Verify secrets are created
query T
SELECT name FROM rw_secrets ORDER BY name;
----
approle_kafka_user
vault_kafka_password


system ok
cat << EOF | kcat -b message_queue_sasl_1:19092 -X security.protocol=SASL_PLAINTEXT -X sasl.mechanism=PLAIN -X sasl.username=dev -X sasl.password=rw -P -t test_kafka_secret_vault
{"x": "a"}
{"x": "b"}
{"x": "c"}
EOF


statement ok
CREATE TABLE test_table (
  id int,
  name varchar
) WITH (
  connector = 'kafka',
  properties.bootstrap.server = 'message_queue_sasl_1:19092',
  properties.sasl.username = SECRET approle_kafka_user,
  properties.sasl.password = SECRET vault_kafka_password,
  properties.security.protocol = 'SASL_PLAINTEXT',
  properties.sasl.mechanism = 'PLAIN',
  topic = 'test_kafka_secret_vault',
) format plain encode json;

# Show the table was created successfully
query T
SELECT table_name FROM information_schema.tables WHERE table_name = 'test_table' and table_type = 'BASE TABLE';
----
test_table


query I retry 3 backoff 1s
select count(*) from test_table
----
3


# Clean up
statement ok
DROP TABLE test_table;

statement ok
DROP SECRET vault_kafka_password;

statement ok
DROP SECRET approle_kafka_user;
