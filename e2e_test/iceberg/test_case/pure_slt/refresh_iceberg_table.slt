control substitution on

statement ok
create secret my_secret with (
  backend = 'meta'
) as 'hummockadmin';

statement ok
create connection my_conn
with (
    type = 'iceberg',
    warehouse.path = 's3://hummock001/iceberg_connection',
    s3.access.key = secret my_secret,
    s3.secret.key = secret my_secret,
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-west-2',
    catalog.type = 'storage',
);

statement ok
set iceberg_engine_connection = 'public.my_conn';

statement ok
create table t_refresh (id int primary key, name varchar, foo varchar) with (commit_checkpoint_interval = 10) engine = iceberg;

statement ok
insert into t_refresh values(1, 'xxx', 'a') , (2, 'yyy', 'b'), (3, 'zzz', 'c'), (4, 'www', 'd'), (5, 'zzz', 'c');

statement ok
flush;

statement ok
delete from t_refresh where id = 4;

statement ok
flush;

sleep 10s

query ? retry 5 backoff 1s
select count(*) = 1 from rw_iceberg_files where source_name = '__iceberg_source_t_refresh' and content = 'PositionDeletes';
----
t


statement error Invalid key
create table iceberg_batch_table ( primary key (id) ) with (
  connector = 'iceberg',
  warehouse.path = 's3://hummock001/iceberg_connection',
  s3.access.key = secret my_secret,
  s3.secret.key = secret my_secret,
  s3.endpoint = 'http://127.0.0.1:9301',
  s3.region = 'us-west-2',
  catalog.type = 'storage',
  table.name = 't_refresh',
  database.name = 'public',
  refresh_mode = 'invalid_option'
);

statement ok
create table iceberg_batch_table ( primary key (id) ) with (
  connector = 'iceberg',
  warehouse.path = 's3://hummock001/iceberg_connection',
  s3.access.key = secret my_secret,
  s3.secret.key = secret my_secret,
  s3.endpoint = 'http://127.0.0.1:9301',
  s3.region = 'us-west-2',
  catalog.type = 'storage',
  table.name = 't_refresh',
  database.name = 'public',
  refresh_mode = 'FULL_RELOAD'
);


query ?
select current_status from rw_refresh_table_state;
----
IDLE


statement ok
refresh table iceberg_batch_table;

query ?
select current_status from rw_refresh_table_state;
----
REFRESHING


# changes on the original table should be available very soon
query I retry 3 backoff 1s
select id from t_refresh order by id;
----
1
2
3
5


# wait for refresh
query I retry 11 backoff 1s
select id from iceberg_batch_table order by id;
----
1
2
3
5


# make sure last succeed time recorded
query ? retry 3 backoff 1s
select count(*) from rw_refresh_table_state where last_success_time is not null;
----
1


# ==== end PositionDeletes

statement ok
delete from t_refresh where name = 'zzz' and foo = 'c';

statement ok
flush;


query ? retry 11 backoff 1s
select count(*) = 1 from rw_iceberg_files where source_name = '__iceberg_source_t_refresh' and content = 'EqualityDeletes';
----
t


statement ok
refresh table iceberg_batch_table;

sleep 15s

query I retry 3 backoff 1s
select id from t_refresh order by id;
----
1
2


# make sure the refresh finished
query ?
select current_status from rw_refresh_table_state;
----
IDLE


query I retry 3 backoff 1s
select id from iceberg_batch_table order by id;
----
1
2


statement ok
drop table iceberg_batch_table;

statement ok
drop table t_refresh;

# ==== Composite primary key refresh table

statement ok
create table t_refresh_composite_pk (
  id2 varchar,
  id1 int,
  name varchar,
  primary key (id1, id2)
) with (commit_checkpoint_interval = 2) engine = iceberg;

statement ok
insert into t_refresh_composite_pk values
  ('10', 1, 'aaa'),
  ('20', 1, 'bbb'),
  ('10', 2, 'ccc'),
  ('20', 2, 'ddd');

statement ok
flush;

sleep 10s

statement ok
create table iceberg_batch_table_composite_pk ( primary key (id1, id2) ) with (
  connector = 'iceberg',
  warehouse.path = 's3://hummock001/iceberg_connection',
  s3.access.key = secret my_secret,
  s3.secret.key = secret my_secret,
  s3.endpoint = 'http://127.0.0.1:9301',
  s3.region = 'us-west-2',
  catalog.type = 'storage',
  table.name = 't_refresh_composite_pk',
  database.name = 'public',
  refresh_mode = 'FULL_RELOAD'
);

statement ok
refresh table iceberg_batch_table_composite_pk;

query II retry 11 backoff 1s
select id1, id2 from iceberg_batch_table_composite_pk order by id1, id2;
----
1 10
1 20
2 10
2 20

statement ok
delete from t_refresh_composite_pk where id1 = 1 and id2 = '20';

statement ok
insert into t_refresh_composite_pk values ('30', 3, 'eee');

statement ok
flush;

sleep 10s

statement ok
refresh table iceberg_batch_table_composite_pk;

query II retry 11 backoff 1s
select id1, id2 from iceberg_batch_table_composite_pk order by id1, id2;
----
1 10
2 10
2 20
3 30

# Cleanup

statement ok
drop table iceberg_batch_table_composite_pk;

statement ok
drop table t_refresh_composite_pk;

statement ok
drop connection my_conn;

statement ok
drop secret my_secret;
