statement ok
set enable_datafusion_engine = true;

statement ok
create secret my_secret with (
  backend = 'meta'
) as 'hummockadmin';

statement ok
create connection my_conn
with (
    type = 'iceberg',
    warehouse.path = 's3://hummock001/iceberg_connection',
    s3.access.key = secret my_secret,
    s3.secret.key = secret my_secret,
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-west-2',
    catalog.type = 'storage',
);

statement ok
set iceberg_engine_connection = 'public.my_conn';

statement ok
create table t(id int) with(commit_checkpoint_interval = 1) engine = iceberg;

statement ok
insert into t select i from generate_series(1, 5) as s(i);

statement ok
FLUSH;

sleep 5s

# ==================== generate_series ====================

query ?? rowsort
select * from t, generate_series(1, 5) where t.id = 1;
----
1 1
1 2
1 3
1 4
1 5

query ?? rowsort
select * from t, generate_series(1, 10, 2) where t.id = 1;
----
1 1
1 3
1 5
1 7
1 9

query ?
select count(*) from t, generate_series(1, 5) as gs1, generate_series(1, 10, 2) as gs2;
----
125

query ?? rowsort
select id, generate_series(1, id) from t;
----
1 1
2 1
2 2
3 1
3 2
3 3
4 1
4 2
4 3
4 4
5 1
5 2
5 3
5 4
5 5

query ?? rowsort
select id, g from t, generate_series(1, id) as s(g);
----
1 1
2 1
2 2
3 1
3 2
3 3
4 1
4 2
4 3
4 4
5 1
5 2
5 3
5 4
5 5

# ==================== unnest ====================

query ?? rowsort
select * from t, unnest(array[1, 2, 3]) where t.id = 1;
----
1 1
1 2
1 3

query ?? rowsort
select * from t, unnest(array['a', 'b', 'c']) where t.id = 1;
----
1 a
1 b
1 c

# test unnest with null values
query ?? rowsort
select * from t, unnest(array[1, null, 3]) where t.id = 1;
----
1 1
1 3
1 NULL

# test unnest with empty array
query ?
select * from t, unnest(array[]::int[]) where t.id = 1;
----

query ?
select sum(x) from t, unnest(array[1, 2, 3, 4, 5]) as u(x) where t.id = 1;
----
15

statement ok
CREATE TABLE array_t (id int, arr int[]) with(commit_checkpoint_interval = 1) engine = iceberg;

statement ok
INSERT INTO array_t VALUES
(1, array[1, 2, 3]),
(2, array[4, 5]),
(3, array[]::int[]),
(4, NULL);

statement ok
FLUSH;

sleep 5s

query ?? rowsort
select id, x from array_t, unnest(arr) as u(x);
----
1 1
1 2
1 3
2 4
2 5

statement ok
DROP TABLE array_t;

statement ok
DROP TABLE t;

statement ok
DROP CONNECTION my_conn;

statement ok
DROP SECRET my_secret;
