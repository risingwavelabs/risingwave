control substitution on

statement ok
create secret lakekeeper_secret with (
  backend = 'meta'
) as 'hummockadmin';

# Test lakekeeper catalog connection using the warehouse created by risedev
statement ok
create connection lakekeeper_catalog_conn
with (
    type = 'iceberg',
    catalog.type = 'rest',
    catalog.uri = 'http://127.0.0.1:8181/catalog/',
    warehouse.path = 'risingwave-warehouse',
    s3.access.key = secret lakekeeper_secret,
    s3.secret.key = secret lakekeeper_secret,
    s3.path.style.access = 'true',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1'
);

statement ok
set iceberg_engine_connection = 'public.lakekeeper_catalog_conn';

statement ok
create table t_vacuum_test(id int primary key, name varchar, v1 int)
with(commit_checkpoint_interval = 1) engine = iceberg;

statement ok
insert into t_vacuum_test values(1, 'alice', 100), (2, 'bob', 200), (3, 'charlie', 300);

statement ok
FLUSH;

sleep 1s

query ??? rowsort
select * from t_vacuum_test;
----
1 alice 100
2 bob 200
3 charlie 300

statement ok
insert into t_vacuum_test values(4, 'david', 400), (5, 'eve', 500);

statement ok
FLUSH;

sleep 1s

statement ok
update t_vacuum_test set v1 = 150 where id = 1;

statement ok
FLUSH;

sleep 1s

statement ok
insert into t_vacuum_test values(6, 'frank', 600), (7, 'grace', 700);

statement ok
FLUSH;

sleep 1s

statement ok
update t_vacuum_test set v1 = 250 where id = 2;

statement ok
FLUSH;

sleep 1s

query ?
select count(*) > 1 from rw_iceberg_files where schema_name = 'public' and source_name = '__iceberg_source_t_vacuum_test';
----
t

query ??? rowsort
select * from t_vacuum_test;
----
1 alice 150
2 bob 250
3 charlie 300
4 david 400
5 eve 500
6 frank 600
7 grace 700


statement ok
VACUUM t_vacuum_test;

query ?
select count(*) > 1 from rw_iceberg_files where schema_name = 'public' and source_name = '__iceberg_source_t_vacuum_test';
----
t

statement ok
VACUUM FULL t_vacuum_test;

# Check file types remaining after VACUUM FULL
# content: 0 = data, 1 = position deletes, 2 = equality deletes
# After the first VACUUM FULL, we expect 1 data file and 1 equality delete file
query ??
select content, count(*) from rw_iceberg_files where schema_name = 'public' and source_name = '__iceberg_source_t_vacuum_test' group by content order by content;
----
0 1
2 1

query ?
select count(*) from rw_iceberg_files where schema_name = 'public' and source_name = '__iceberg_source_t_vacuum_test';
----
2

# Verify data is correct
query ??? rowsort
select * from t_vacuum_test;
----
1 alice 150
2 bob 250
3 charlie 300
4 david 400
5 eve 500
6 frank 600
7 grace 700

# Run VACUUM FULL again to clean up the equality delete file
statement ok
VACUUM FULL t_vacuum_test;

# After the second VACUUM FULL, only the data file should remain
query ??
select content, count(*) from rw_iceberg_files where schema_name = 'public' and source_name = '__iceberg_source_t_vacuum_test' group by content order by content;
----
0 1

query ?
select count(*) from rw_iceberg_files where schema_name = 'public' and source_name = '__iceberg_source_t_vacuum_test';
----
1

# Verify data is still correct
query ??? rowsort
select * from t_vacuum_test;
----
1 alice 150
2 bob 250
3 charlie 300
4 david 400
5 eve 500
6 frank 600
7 grace 700


# Cleanup
statement ok
DROP TABLE t_vacuum_test;

statement ok
DROP CONNECTION lakekeeper_catalog_conn;

statement ok
DROP SECRET lakekeeper_secret;
