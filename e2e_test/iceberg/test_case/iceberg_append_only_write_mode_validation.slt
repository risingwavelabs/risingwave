# Test enforcement of merge-on-read write mode for append-only iceberg sinks
# This test verifies that copy-on-write is rejected for append-only sinks

statement ok
CREATE TABLE t_append_only (
    id bigint primary key,
    data varchar
);

# Test case 1: Error - append-only sink with copy-on-write mode should be rejected
statement error 'copy-on-write' mode is not supported for append-only iceberg sink
CREATE SINK s_append_only_cow AS SELECT * FROM t_append_only WITH (
    connector = 'iceberg',
    type = 'append-only',
    database.name = 'demo_db',
    table.name = 'test_append_only_cow',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true',
    write_mode = 'copy-on-write'
);

# Test case 2: Success - append-only sink with merge-on-read mode (explicit)
statement ok
CREATE SINK s_append_only_mor AS SELECT * FROM t_append_only WITH (
    connector = 'iceberg',
    type = 'append-only',
    database.name = 'demo_db',
    table.name = 'test_append_only_mor',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true',
    write_mode = 'merge-on-read'
);

statement ok
DROP SINK s_append_only_mor;

# Test case 3: Success - append-only sink without explicit write_mode (should default to merge-on-read)
statement ok
CREATE SINK s_append_only_default AS SELECT * FROM t_append_only WITH (
    connector = 'iceberg',
    type = 'append-only',
    database.name = 'demo_db',
    table.name = 'test_append_only_default',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true'
);

statement ok
DROP SINK s_append_only_default;

# Clean up
statement ok
DROP TABLE t_append_only;
