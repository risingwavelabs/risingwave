# Test cases for iceberg sink compaction_type validation
# This file tests validation logic for compaction_type parameter

statement ok
DROP TABLE IF EXISTS t_validation;

statement ok
CREATE TABLE t_validation (
    id bigint primary key,
    data varchar
);

# Test case 1: Error - unknown compaction_type
statement error Unknown compaction type 'invalid-type'
CREATE SINK s_unknown AS SELECT * FROM t_validation WITH (
    connector = 'iceberg',
    type = 'upsert',
    primary_key = 'id',
    database.name = 'demo_db',
    table.name = 'test_unknown',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true',
    compaction.type = 'invalid_type'
);

# Test case 2: Error - COW mode with non-full compaction_type (small_files)
statement error Copy-on-write mode only supports 'full' compaction type
CREATE SINK s_cow_small_files AS SELECT * FROM t_validation WITH (
    connector = 'iceberg',
    type = 'upsert',
    primary_key = 'id',
    database.name = 'demo_db',
    table.name = 'test_cow_small',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true',
    write_mode = 'copy-on-write',
    compaction.type = 'small_files'
);

# Test case 3: Error - COW mode with files_with_delete
statement error Copy-on-write mode only supports 'full' compaction type
CREATE SINK s_cow_files_delete AS SELECT * FROM t_validation WITH (
    connector = 'iceberg',
    type = 'upsert',
    primary_key = 'id',
    database.name = 'demo_db',
    table.name = 'test_cow_delete',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true',
    write_mode = 'copy-on-write',
    compaction.type = 'files_with_delete'
);

# Test case 4: Error - small_files with conflicting parameter delete_files_count_threshold
statement error `compaction.delete_files_count_threshold` is not supported for 'small-files' compaction type
CREATE SINK s_small_files_conflict AS SELECT * FROM t_validation WITH (
    connector = 'iceberg',
    type = 'upsert',
    primary_key = 'id',
    database.name = 'demo_db',
    table.name = 'test_small_conflict',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true',
    write_mode = 'merge-on-read',
    compaction.type = 'small_files',
    compaction.delete_files_count_threshold = '5'
);

# Test case 5: Error - files_with_delete with conflicting parameter small_files_threshold_mb
statement error `compaction.small_files_threshold_mb` must not be set for 'files-with-delete' compaction type
CREATE SINK s_delete_files_conflict AS SELECT * FROM t_validation WITH (
    connector = 'iceberg',
    type = 'upsert',
    primary_key = 'id',
    database.name = 'demo_db',
    table.name = 'test_delete_conflict',
    catalog.name = 'demo',
    catalog.type = 'storage',
    warehouse.path = 's3a://icebergdata/demo',
    s3.endpoint = 'http://127.0.0.1:9301',
    s3.region = 'us-east-1',
    s3.access.key = 'hummockadmin',
    s3.secret.key = 'hummockadmin',
    create_table_if_not_exists = 'true',
    write_mode = 'merge-on-read',
    compaction.type = 'files_with_delete',
    compaction.small_files_threshold_mb = '128'
);

# Clean up
statement ok
DROP TABLE t_validation;
