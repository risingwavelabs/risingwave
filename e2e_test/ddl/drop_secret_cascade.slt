# Test DROP SECRET CASCADE functionality
# This test verifies that when dropping a secret with CASCADE,
# all dependent objects are properly removed.

# Test 1: Create source that uses the secret
statement ok
create secret source_secret with (  
    backend = 'meta'  
) as 'test_value'; 

statement ok
create source test_source (    
    v1 int,    
    v2 varchar    
) with (    
    connector = 'datagen',    
    fields.v1.secret = secret source_secret    
) FORMAT PLAIN ENCODE JSON;

# Test 2: Create connection that uses the secret
statement ok
CREATE SECRET conn_secret WITH (
    backend = 'meta'
) AS 'message_queue:29092';

statement ok
create connection test_connection with (
    type = 'kafka',
    properties.bootstrap.server = secret conn_secret,
    properties.security.protocol = 'plaintext'
);

# Test 3: Create sink that uses the secret
statement ok
CREATE SECRET sink_secret WITH (
    backend = 'meta'
) AS 'message_queue:29092';

statement ok
CREATE SINK test_sink FROM t_kafka WITH (
    connector = 'kafka',
    properties.bootstrap.server = secret sink_secret,
    topic = 'test-rw-sink-append-only',
    type = 'append-only',
    force_append_only = 'true'
);

# Verify all objects exist before cascade drop
query T
SELECT secret_name FROM rw_secrets WHERE name LIKE '%secret%';
----
conn_secret
source_secret
sink_secret

query T
SELECT count(name) FROM rw_sources WHERE name = 'test_source';
----
1

query T
SELECT count(name) FROM rw_connections WHERE name = 'test_connection';
----
1


query T
SELECT count(name) FROM rw_sinks WHERE name = 'test_sink';
----
1

statement error
DROP SECRET source_secret;

statement ok
DROP SECRET source_secret CASCADE;

# Verify cascade deletion worked correctly
# The secret should be gone
query T
SELECT count(secret_name) FROM rw_secrets WHERE name = 'source_secret';
----
0

# The source that used the secret should be gone
query T
SELECT count(name) FROM rw_sources WHERE name = 'test_source';
----
0

# Other unrelated objects should still exist
query T
SELECT name FROM rw_secrets WHERE name LIKE '%secret%';
----
conn_secret
sink_secret

query T
SELECT count(*) FROM rw_connections WHERE name = 'test_connection';
----
1

query T
SELECT count(*) FROM rw_sinks WHERE name = 'test_sink';
----
1

statement error
DROP SECRET conn_secret;

statement ok
DROP SECRET conn_secret CASCADE;

query T
SELECT name FROM rw_secrets WHERE name LIKE '%secret%';
----
sink_secret

query T
SELECT count(*) FROM rw_sinks WHERE name = 'test_sink';
----
1

statement error
DROP SECRET sink_secret;

statement ok
DROP SECRET sink_secret CASCADE;

query T
SELECT name FROM rw_secrets WHERE name LIKE '%secret%';
----