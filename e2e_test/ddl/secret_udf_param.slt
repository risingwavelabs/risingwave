# Test secret references as UDF parameters using WITH options
# This tests the primary use case: UDFs calling external APIs with secret credentials

statement ok
CREATE SECRET http_token WITH (backend = 'meta') AS 'secret_bearer_token_xyz';

statement ok
CREATE SECRET db_host WITH (backend = 'meta') AS 'db.example.com';

# Example: SQL UDF with secret passed via WITH option
# The secret is available as an implicit parameter in the function body
statement ok
CREATE FUNCTION get_token_length(dummy INT) RETURNS INT LANGUAGE sql AS 'SELECT length(token)' WITH (token = secret http_token);

query I
SELECT get_token_length(1);
----
23

statement ok
DROP FUNCTION get_token_length;

# Example: Multiple secrets in a single function
statement ok
CREATE FUNCTION combine_secrets(dummy INT) RETURNS VARCHAR LANGUAGE sql AS 'SELECT token || '' @ '' || host' WITH (token = secret http_token, host = secret db_host);

query T
SELECT combine_secrets(1);
----
secret_bearer_token_xyz @ db.example.com

statement ok
DROP FUNCTION combine_secrets;

# Example: Secret with AS FILE option
statement ok
CREATE FUNCTION get_token_file(dummy INT) RETURNS VARCHAR LANGUAGE sql AS 'SELECT file_path' WITH (file_path = secret http_token AS FILE);

# Just verify it executes (file path will vary)
statement ok
SELECT get_token_file(1);

statement ok
DROP FUNCTION get_token_file;

# Clean up
statement ok
DROP SECRET http_token;

statement ok
DROP SECRET db_host;
