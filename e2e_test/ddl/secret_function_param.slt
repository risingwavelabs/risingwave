# Test secret references in function parameters

statement ok
CREATE SECRET api_key WITH (backend = 'meta') AS 'test_api_key_value';

statement ok
CREATE SECRET db_password WITH (backend = 'meta') AS 'super_secret_password';

# Test secret as TEXT reference (default)
statement ok
SELECT secret api_key;

# Test secret with AS FILE reference
statement ok
SELECT secret api_key AS FILE;

# Test secret in builtin string functions - secrets are passed as varchar literals
# For strlen(secret api_key), the secret value 'test_api_key_value' should be passed
# and strlen should return 18 (length of 'test_api_key_value')
statement ok
SELECT length(secret api_key) = 18;

# Test multiple secrets in function arguments
statement ok
SELECT length(secret api_key) + length(secret db_password) = 18 + 22;

# Test secret in concatenation
statement ok
SELECT concat(secret api_key, '_', secret db_password);

# Test secret in CASE expression
statement ok
SELECT CASE WHEN length(secret api_key) > 0 THEN secret db_password ELSE 'default' END;

# Test secret with parameter in builtin function
statement ok
SELECT substring(secret api_key, 1, 4) = 'test';

# Test secret as TEXT (default reference type)
statement ok
SELECT length(secret api_key AS TEXT) = 18;

# Clean up
statement ok
DROP SECRET api_key;

statement ok
DROP SECRET db_password;

# Secrets referenced by streaming jobs should block dropping the secret until the job is dropped
statement ok
CREATE SECRET stream_secret WITH (backend = 'meta') AS 'stream_secret_value';

statement ok
CREATE MATERIALIZED VIEW mv_secret_dep AS SELECT length(secret stream_secret);

statement error
DROP SECRET stream_secret;

statement ok
DROP MATERIALIZED VIEW mv_secret_dep;

statement ok
DROP SECRET stream_secret;

# Sink with secret function argument should also block drop
statement ok
CREATE TABLE t_secret(v int);

statement ok
INSERT INTO t_secret VALUES (1);

statement ok
CREATE SECRET sink_secret WITH (backend = 'meta') AS 'sink_secret_value';

statement ok
CREATE SINK sink_secret_dep AS SELECT length(secret sink_secret) FROM t_secret WITH (connector = 'blackhole');

statement error
DROP SECRET sink_secret;

statement ok
DROP SINK sink_secret_dep;

statement ok
DROP SECRET sink_secret;

statement ok
DROP TABLE t_secret;

# Verify secrets are dropped
query T
SHOW SECRETS;
----
