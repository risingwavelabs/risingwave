# Test secret references in function parameters using WITH options
# Secrets are passed implicitly to functions via WITH (secret_param = secret <secret_name>) syntax

statement ok
CREATE SECRET api_key WITH (backend = 'meta') AS 'test_api_key_value';

statement ok
CREATE SECRET db_password WITH (backend = 'meta') AS 'super_secret_password';

# Test SQL UDF with secret reference via WITH option
# The secret is passed as an implicit argument accessible by name in the function body
statement ok
CREATE FUNCTION get_secret_length(dummy INT) RETURNS INT LANGUAGE sql AS 'SELECT length(api_key)' WITH (api_key = secret api_key);

query I
SELECT get_secret_length(1);
----
18

statement ok
DROP FUNCTION get_secret_length;

# Test SQL UDF with multiple secret references
statement ok
CREATE FUNCTION get_combined_length(dummy INT) RETURNS INT LANGUAGE sql AS 'SELECT length(api_key) + length(db_pass)' WITH (api_key = secret api_key, db_pass = secret db_password);

query I
SELECT get_combined_length(1);
----
40

statement ok
DROP FUNCTION get_combined_length;

# Test SQL UDF with secret and regular parameter
statement ok
CREATE FUNCTION concat_with_secret(prefix VARCHAR) RETURNS VARCHAR LANGUAGE sql AS 'SELECT prefix || api_key' WITH (api_key = secret api_key);

query T
SELECT concat_with_secret('prefix_');
----
prefix_test_api_key_value

statement ok
DROP FUNCTION concat_with_secret;

# Test secret AS FILE reference in WITH option
statement ok
CREATE FUNCTION get_secret_file_path(dummy INT) RETURNS VARCHAR LANGUAGE sql AS 'SELECT file_secret' WITH (file_secret = secret api_key AS FILE);

# Note: The result will be a file path, we just verify it executes without error
statement ok
SELECT get_secret_file_path(1);

statement ok
DROP FUNCTION get_secret_file_path;

# Clean up test secrets
statement ok
DROP SECRET api_key;

statement ok
DROP SECRET db_password;

# Test dependency tracking: function with secret should block dropping the secret
statement ok
CREATE SECRET dep_secret WITH (backend = 'meta') AS 'dep_secret_value';

statement ok
CREATE FUNCTION func_with_secret(dummy INT) RETURNS INT LANGUAGE sql AS 'SELECT length(my_secret)' WITH (my_secret = secret dep_secret);

# Dropping secret should fail while function depends on it
statement error
DROP SECRET dep_secret;

statement ok
DROP FUNCTION func_with_secret;

# Now dropping secret should succeed
statement ok
DROP SECRET dep_secret;


statement ok
CREATE SECRET http_token WITH (backend = 'meta') AS 'secret_bearer_token_xyz';

statement ok
CREATE SECRET db_host WITH (backend = 'meta') AS 'db.example.com';

# Example: SQL UDF with secret passed via WITH option
# The secret is available as an implicit parameter in the function body
statement ok
CREATE FUNCTION get_token_length(dummy INT) RETURNS INT LANGUAGE sql AS 'SELECT length(token)' WITH (token = secret http_token);

query I
SELECT get_token_length(1);
----
23

statement ok
DROP FUNCTION get_token_length;

# Example: Multiple secrets in a single function
statement ok
CREATE FUNCTION combine_secrets(dummy INT) RETURNS VARCHAR LANGUAGE sql AS 'SELECT token || '' @ '' || host' WITH (token = secret http_token, host = secret db_host);

query T
SELECT combine_secrets(1);
----
secret_bearer_token_xyz @ db.example.com

statement ok
DROP FUNCTION combine_secrets;

# Example: Secret with AS FILE option
statement ok
CREATE FUNCTION get_token_file(dummy INT) RETURNS VARCHAR LANGUAGE sql AS 'SELECT file_path' WITH (file_path = secret http_token AS FILE);

# Just verify it executes (file path will vary)
statement ok
SELECT get_token_file(1);

statement ok
DROP FUNCTION get_token_file;

# Clean up
statement ok
DROP SECRET http_token;

statement ok
DROP SECRET db_host;

# Verify secrets are dropped
query T
SHOW SECRETS;
----
