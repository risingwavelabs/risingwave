# Copied from https://github.com/duckdb/duckdb (MIT licensed).
# Copyright 2018-2022 Stichting DuckDB Foundation 

# description: Test ORDER BY keyword

statement ok
SET RW_IMPLICIT_FLUSH TO true;

statement ok
CREATE TABLE test (a INTEGER, b INTEGER);

statement ok
INSERT INTO test VALUES (11, 22), (12, 21), (13, 22);

# simple ORDER BY
query I
SELECT b FROM test ORDER BY a DESC;
----
22
21
22

query II
SELECT a, b FROM test ORDER BY a;
----
11	22
12	21
13	22

query II
SELECT a, b FROM test ORDER BY a DESC;
----
13	22
12	21
11	22

# ORDER BY on multiple columns
query II
SELECT a, b FROM test ORDER BY b, a;
----
12	21
11	22
13	22

# ORDER BY using select indices
query II
SELECT a, b FROM test ORDER BY 2, 1;
----
12	21
11	22
13	22

query II
SELECT a, b FROM test ORDER BY b DESC, a;
----
11	22
13	22
12	21

query II
SELECT a, b FROM test ORDER BY b, a DESC;
----
12	21
13	22
11	22

# TOP N queries
query II
SELECT a, b FROM test ORDER BY b, a DESC LIMIT 1;
----
12	21

# Offset
query II
SELECT a, b FROM test ORDER BY b, a DESC LIMIT 1 OFFSET 1;
----
13	22

# Offset without limit
query II
SELECT a, b FROM test ORDER BY b, a DESC OFFSET 1;
----
13	22
11	22

query II
SELECT a, b FROM test WHERE a < 13 ORDER BY b;
----
12	21
11	22

query II
SELECT a, b FROM test WHERE a < 13 ORDER BY 2;
----
12	21
11	22

query II
SELECT a, b FROM test WHERE a < 13 ORDER BY b DESC;
----
11	22
12	21

query II
SELECT b, a FROM test WHERE a < 13 ORDER BY b DESC;
----
22	11
21	12

# order by expression
# https://github.com/risingwavelabs/risingwave/issues/4681
# query IR
# SELECT b % 2 AS f, SUM(a) FROM test GROUP BY f ORDER BY b % 2;
query II
SELECT b % 2, SUM(a) FROM test GROUP BY b % 2 ORDER BY b % 2;
----
0	24
1	12

# order by expression that is not in SELECT
query II
SELECT b % 2 AS f, a FROM test ORDER BY b % 2, a;
----
0	11
0	13
1	12

# ORDER BY alias
# query IR
# SELECT b % 2 AS f, SUM(a) FROM test GROUP BY f ORDER BY f;
query II
SELECT b % 2 AS f, SUM(a) FROM test GROUP BY b % 2 ORDER BY f;
----
0	24
1	12

# query IR
# SELECT b % 2 AS f, SUM(a) FROM test GROUP BY f ORDER BY 1;
query II
SELECT b % 2 AS f, SUM(a) FROM test GROUP BY b % 2 ORDER BY 1;
----
0	24
1	12

# ORDER BY after union
# query I
# SELECT a-10 AS k FROM test UNION SELECT a-10 AS l FROM test ORDER BY k;
# ----
# 1
# 2
# 3

# ORDER BY on alias in right-most query
# CONTROVERSIAL: SQLite allows both "k" and "l" to be referenced here, Postgres and MonetDB give an error.
# query I
# SELECT a-10 AS k FROM test UNION SELECT a-10 AS l FROM test ORDER BY l;
# ----
# 1
# 2
# 3

# computations with aliases are not allowed though
# statement error
# SELECT a-10 AS k FROM test UNION SELECT a-10 AS l FROM test ORDER BY 1-k;

# but ordering on computation elements should work
# query I
# SELECT a-10 AS k FROM test UNION SELECT a-10 AS l FROM test ORDER BY a-10;
# ----
# 1
# 2
# 3

# query I
# SELECT a-10 AS k FROM test UNION SELECT a-11 AS l FROM test ORDER BY a-11;
# ----
# 0
# 1
# 2
# 3

statement ok
drop table test;
