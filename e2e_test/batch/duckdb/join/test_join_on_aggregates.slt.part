# Copied from https://github.com/duckdb/duckdb (MIT licensed).
# Copyright 2018-2022 Stichting DuckDB Foundation 

# description: Test join on aggregates

statement ok
SET RW_IMPLICIT_FLUSH TO true;

statement ok
SET CREATE_COMPACTION_GROUP_FOR_MV TO true;

statement ok
CREATE TABLE integers(i INTEGER);

statement ok
INSERT INTO integers VALUES (1), (2), (3), (NULL);

# test join on ungrouped aggregates
query RR
SELECT * FROM (SELECT SUM(i) AS x FROM integers) a, (SELECT SUM(i) AS x FROM integers) b WHERE a.x=b.x;
----
6	6

# Test join on aggregates with GROUP BY
statement ok
CREATE TABLE groups(i INTEGER, j INTEGER);

statement ok
INSERT INTO groups VALUES (1, 1), (2, 1), (3, 2), (NULL, 2);

query IRII
SELECT a.j,a.x,a.y,b.y FROM (SELECT j, MIN(i) AS y, SUM(i) AS x FROM groups GROUP BY j) a, (SELECT j, MIN(i) AS y, SUM(i) AS x FROM groups GROUP BY j) b WHERE a.j=b.j AND a.x=b.x ORDER BY a.j;
----
1	3	1	1
2	3	3	3

statement ok
DROP TABLE integers;

statement ok
DROP TABLE groups;
