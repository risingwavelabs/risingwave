statement ok
create table t(v int) APPEND ONLY with (retention_seconds = 5);

statement ok
create index i on t(v);

statement ok
insert into t values(1);

statement ok
flush;

query I
select * from t;
----
1

query I
select * from i;
----
1

statement error
create table t_non_append_only(v int) with (retention_seconds = 5);

statement ok
set unsafe_enable_storage_retention_for_non_append_only_tables to true;

statement ok
create table t_non_append_only(v int) with (retention_seconds = 5);

statement ok
insert into t_non_append_only values(1);

statement ok
flush;

query I
select * from t_non_append_only;
----
1

statement ok
flush;

statement ok
select pg_sleep(10);

query I
select * from t;
----

query I
select * from i;
----

query I
select * from t_non_append_only;
----

statement ok
drop table t;

statement ok
drop table t_non_append_only;