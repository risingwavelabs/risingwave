# LDAP Authentication Test
# This test verifies that LDAP authentication works correctly
# It tests both simple bind and search+bind modes (configured at cluster level)

# Test 1: Create a user in RisingWave database
statement ok
CREATE USER testuser1;

statement ok
GRANT ALL PRIVILEGES ON SCHEMA public TO testuser1;

# Test 2: Successful LDAP authentication
system ok
PGPASSWORD=testpass1 psql -U testuser1 -c "SELECT 1 AS test;"

# Test 3: Verify user can connect and execute queries
system ok
PGPASSWORD=testpass1 psql -U testuser1 -c "CREATE TABLE test_table (id INT, name VARCHAR);"

system ok
PGPASSWORD=testpass1 psql -U testuser1 -c "INSERT INTO test_table VALUES (1, 'test1'), (2, 'test2');FLUSH;"

# Test 4: Verify user can query data
system ok
PGPASSWORD=testpass1 psql -U testuser1 -c "SELECT * FROM test_table;" | grep -q "test1"

system ok
PGPASSWORD=testpass1 psql -U testuser1 -c "SELECT count(*) FROM test_table;" | grep -q "2"

# Cleanup
statement ok
DROP TABLE test_table;

statement ok
DROP USER testuser1;
